# 一、provider package

简单的应用状态管理，<https://docs.flutter.cn/data-and-backend/state-mgmt/simple>
Flutter 状态管理框架 Provider 和 Get 分析，<https://docs.flutter.cn/community/tutorials/state-management-package-getx-provider-analysis>
provider package，<https://pub-web.flutter-io.cn/packages/provider> <https://github.com/rrousselGit/provider>

provider package 是基于 Flutter 中的 `InheritedWidget` 实现的，通过 Flutter 树机制 为其子孙节点提供数据，从而实现跨组件数据通信。

> provider package 的核心是 “提供者（Provider）” + “消费者（Consumer）” 模式。
> provider 是中小型项目或模块级状态管理的理想选择。

provider package 的特点：
  - 依赖树机制，必须基于 `context`。
  - 自动生命周期管理：如，Provider 默认会自动 dispose ChangeNotifier，无需手动处理。
  - 只重建依赖数据的 widget（局部刷新）。
  - 业务逻辑与 UI 分离。
  - 支持多种数据源：ChangeNotifier、Future、Stream、普通值等。

## 1、添加 provider package 依赖

```shell
$ flutter pub add provider
```

## 2、开始使用 provider

```dart
import 'package:provider/provider.dart'; 
```

provider package 中三个核心概念：
  - `ChangeNotifier` 用于定义响应式模型，存储App状态。
  - `ChangeNotifierProvider` 作用是把响应式模型(即，ChangeNotifier) 与 应用中的 widget 相关联。
  -  `Consumer` 作用是在 App Widget 结构中监听 ChangeNotifier 从而来构建 Widget。

### ChangeNotifier

ChangeNotifier 是 Flutter SDK 中的一个简单的类，它用于向监听器发送通知，可以订阅它的状态变化。遵循观察者模式。

在 provider 中，ChangeNotifier 是一种能够封装应用程序状态的方法。对于特别简单的程序，你可以通过一个 ChangeNotifier 来满足全部需求。 在相对复杂的应用中，由于会有多个模型，所以可能会有多个 ChangeNotifier。 可以把 ChangeNotifier 和 provider 结合起来用。

### ChangeNotifierProvider<T> Widget

ChangeNotifierProvider 是 provider package 中最常用的一种 Provider，它向其子组件暴露一个 ChangeNotifier 实例 (被观察者)，并在状态发生变化时通知监听者重建 UI。

### Consumer<T>

Consumer 是一个非常核心的 widget，用于监听并消费由 Provider 提供的数据变化。它允许你在 widget 树中的任意位置访问由 Provider（如 ChangeNotifierProvider、ValueListenableProvider 等）暴露出来的数据，并在其发生变化时自动重建 UI。

`<T>`，是指要消费的数据类型，必须与 Provider 提供的类型一致

创建 Consumer 唯一必须的参数就是 builder。当 ChangeNotifier 发生变化的时候会调用 builder 这个函数。
最好能把 Consumer 放在 widget 树尽量低的位置上。避免 UI 上任何一点小变化就全盘重新构建 widget 。


# 二、provider package 的其它重要 API

* `Provider.of<T>` 静态方法，从 widget 树中获取由 Provider 提供的类型为 T 的数据实例的方法。适用于 不需要模型中的 数据 来改变 UI 的场景。

## Provider（提供者）

Provider 用于向 widget 子树提供数据，常见的类型有：

`Provider`，提供普通对象（不可变或手动通知）。
`ChangeNotifierProvider`，提供 ChangeNotifier 对象（最常用）。
`FutureProvider`，提供异步 Future 的结果	`Future<T>`。
`StreamProvider`，提供 Stream 的最新值	`Stream<T>`。
`ValueListenableProvider`，提供 `ValueListenable`（如 ValueNotifier）	`ValueNotifier<T>`。


## Consumer（消费者）

* `Consumer<T>`，监听并构建 UI。

* `context.watch<T>`，在 build 方法中监听数据（简洁写法），当前 widget 会 rebuild。

* `context.read<T>()`，仅读取数据，不监听，通常用于事件回调，避免在 build 中使用。

* `Selector<T, R>`，只监听对象的某一部分（性能更优）。